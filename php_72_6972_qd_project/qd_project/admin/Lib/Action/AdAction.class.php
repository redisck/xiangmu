<?php	class AdAction extends CommonAction{		public function index(){			$this->init();			$ad=M('Ad');			import('ORG.Util.Page');			$count=$ad->count();			$page=new Page($count,4);			$this->show=$page->show();			$ad_list=$ad->limit($page->firstRow.','.$page->listRows)->select();			foreach($ad_list as $key=>$value){				$arr=explode("_",$ad_list[$key]['image']);				$ad_list[$key]['image_first']=$arr[0];				$ad_list[$key]['image_last']=$arr[1];				$ad_list[$key]['root']=C('Ad_image_path');			}			$this->assign("ad_list",$ad_list);			$this->display();		}		public function add(){			$this->init();			 if(empty($_POST['type']) || empty($_POST['title']) || empty($_POST['href']) || !isset($_POST['status'])){				echo "<script>alert('信息填写不正确')</script>";				$this->redirect('Ad/index');			}			$ad_root=C('Ad_image_path');			$ad_common=C('Ad_image_common');			//组装上传路径			$date_dir=date("Y-m");			if(!file_exists($ad_root.'/'.$date_dir)){				mkdir($ad_root.'/'.$date_dir);				mkdir($ad_root.'/'.$date_dir.'/common/');			}			import('ORG.Net.UploadFile');			$upload=new UploadFile();			$upload->maxSize=C('Goods_image_max');			$upload->allowExts=C('allowExts');			$upload->savePath=$ad_root.'/'.$date_dir.'/common/';			if(!$upload->upload()){				echo "<script>alert('上传失败')</script>";				$this->redirect('Ad/index');			}			//获取上传信息			$info=$upload->getUploadFileInfo();			$save_name=$info[0]['savename'];			$_POST['image']=$date_dir."_".$save_name;			$ad=M("Ad");			$max_status=$ad->max('status');			if($_POST['status']==1){				$_POST['status']=$max_status+1;			}			$data=$_POST;			$res=$ad->add($data);			if($res){				echo "<script>alert('添加成功')</script>";				$this->redirect('Ad/index');			}		}		public function edit(){			$this->init();			  if(empty($_POST['title']) || empty($_POST['href'])){				echo "<script>alert('信息填写不正确')</script>";				$this->redirect('Ad/index');			}			$ad_root=C('Ad_image_path');			$ad_common=C('Ad_image_common');			//组装上传路径			$date_dir=date("Y-m");			if(!file_exists($ad_root.'/'.$date_dir)){				mkdir($ad_root.'/'.$date_dir);				mkdir($ad_root.'/'.$date_dir.'/common/');			}			import('ORG.Net.UploadFile');			$upload=new UploadFile();			$upload->maxSize=C('Goods_image_max');			$upload->allowExts=C('allowExts');			$upload->savePath=$ad_root.'/'.$date_dir.'/common/';			if(!$upload->upload()){				echo "<script>alert('上传失败')</script>";				$this->redirect('Ad/index');			}			//获取上传信息			$info=$upload->getUploadFileInfo();			$save_name=$info[0]['savename'];			$_POST['image']=$date_dir."_".$save_name;			$data['title']=$_POST['title'];			$data['href']=$_POST['href'];			$data['image']=$_POST['image'];			$ad=M("Ad");			$res=$ad->where("id={$_POST['id']}")->save($data); 			if($res){				echo "<script>alert('修改成功')</script>";				$this->redirect('Ad/index');			} 		}		public function ajax_href(){			$ad=M("Ad");			$info=$ad->where("id={$_POST['id']}")->find();			echo json_encode($info);		}	}